var config={width:800,height:450,nBalls:4,G:2e-4,highPrecision:!1,potential:"repulsive",kAttractive:-.3,kRepulsive:.07,rMin:.03,rMax:.06,rColl:.5,rWell:2,hMin:.4,hMax:.7,keybindings:{r:"restart",t:"toggle-potential","+":"add-ball","-":"remove-ball",p:"toggle-precision"}};window.addEventListener("load",function(){function a(b){var c,d,e;for(null===p&&(p=b),c=b-p,c>q&&(c=0),p=b,s++,t+=c,t>1e3&&(w.textContent=(1e3*s/t).toFixed(1),t=0,s=0),e=config.highPrecision===!0?graphics.computeField(metaballs.balls,o,config.width,config.height):graphics.computeFieldFromPrecomputed(metaballs.balls,metaballs.fields,o,config.width,config.height),o.putImageData(e,0,0),c+=u,d=Math.floor(c/v),u=c-d*v;d--;)dynamics.takeTimestep(metaballs.balls,v,config);r=window.requestAnimationFrame(a)}function b(){null!==r&&(window.cancelAnimationFrame(r),r=null)}function c(){r=window.requestAnimationFrame(a)}function d(){k(),e(),l(),keybindings.listBindings(config.keybindings,A,document.getElementById("keys")),keybindings.bindKeys(config.keybindings,A),n.addEventListener("mousemove",function(a){m.x0=a.clientX-n.offsetLeft-z.offsetLeft,m.y0=a.clientY-n.offsetTop-z.offsetTop}),c()}function e(){metaballs.generateBalls(config),m=metaballs.balls[0],m.oneOverR2=0}function f(){b(),e(),l(),c()}function g(){b(),config.nBalls++,metaballs.addNonCollidingBall(config),c()}function h(){1!==metaballs.balls.length&&(b(),config.nBalls--,metaballs.popBall(),c())}function i(){b(),config.potential="repulsive"===config.potential?"attractive":"repulsive",k(),metaballs.computeCoefficients(config.k),c()}function j(){b(),config.highPrecision=config.highPrecision===!0?!1:!0,l(),c()}function k(){"repulsive"===config.potential?(config.k=config.kRepulsive,x.textContent="repulsive"):(config.k=config.kAttractive,x.textContent="attractive")}function l(){config.highPrecision===!0?(y.textContent="on",metaballs.discardFields()):(y.textContent="off",metaballs.fields.length!==metaballs.balls.length&&metaballs.precomputeFields(config))}var m,n=document.getElementById("main"),o=n.getContext("2d"),p=null,q=1e3,r=null,s=0,t=0,u=0,v=5,w=document.getElementById("fps"),x=document.getElementById("potential"),y=document.getElementById("precision"),z=n.offsetParent,A={restart:{callback:f,description:"restart"},"add-ball":{callback:g,description:"add a ball"},"remove-ball":{callback:h,description:"remove a ball"},"toggle-potential":{callback:i,description:"toggle potential"},"toggle-precision":{callback:j,description:"toggle precision"}};n.width=config.width,n.height=config.height,n.style.width=config.width+"px",n.style.height=config.height+"px",d()});var dynamics={applyForces:function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(c=0,e=a.length;e>c;c++)a[c].Fx=a[c].Fy=0;for(c=0;e>c;c++){for(i=a[c],d=c+1;e>d;d++)j=a[d],f=j.x0-i.x0,g=j.y0-i.y0,h=Math.sqrt(f*f+g*g),k=b*j.R2*i.F(h)/h,m=f*k,l=g*k,j.Fx-=m,j.Fy-=l,i.Fx+=m,i.Fy+=l;i.ax=i.oneOverR2*i.Fx,i.ay=i.oneOverR2*i.Fy}},integrate:function(a,b,c){var d,e,f,g=b/2;for(d=0,e=a.length;e>d;d++)f=a[d],f.vxHalf=f.vx+g*f.ax,f.vyHalf=f.vy+g*f.ay,f.x0+=b*f.vxHalf,f.y0+=b*f.vyHalf;for(dynamics.applyForces(a,c),d=0;e>d;d++)f=a[d],f.vx=f.vxHalf+g*f.ax,f.vy=f.vyHalf+g*f.ay},solveCollisions:function(a,b,c){var d,e,f,g;for(d=0,e=a.length;e>d;d++)f=a[d],g=f.Rcoll,f.x0-g<0&&(f.x0=g,f.vx*=-1),f.x0+g>b&&(f.x0=b-g,f.vx*=-1),f.y0-g<0&&(f.y0=g,f.vy*=-1),f.y0+g>c&&(f.y0=c-g,f.vy*=-1)},takeTimestep:function(a,b,c){dynamics.integrate(a,b,c.G),dynamics.solveCollisions(a,c.width,c.height)}},graphics={computeFieldFromPrecomputed:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o=c.createImageData(d,e),p=o.data,q=3*d,r=[],s=0,t=0;for(n=0,k=a.length;k>n;n++)r[n]=3*(2*Math.floor(e-a[n].y0)*d+Math.floor(d-a[n].x0));for(m=0;e>m;m++){for(l=0;d>l;l++){for(h=i=j=0,n=0;k>n;n++)g=b[n],f=r[n]+t,h+=g[f],i+=g[f+1],j+=g[f+2];t+=3,p[s++]=h,p[s++]=i,p[s++]=j,p[s++]=255}t+=q}return o},computeField:function(a,b,c,d){var e,f,g,h,i,j,k,l,m=b.createImageData(c,d),n=m.data,o=a.length,p=0;for(k=0;d>k;k++)for(j=0;c>j;j++){for(f=g=h=0,l=0;o>l;l++)e=a[l].RGB,i=a[l].f(j,k),f+=i*e.R,g+=i*e.G,h+=i*e.B;n[p++]=f,n[p++]=g,n[p++]=h,n[p++]=255}return m},HSVtoRGB:function(a,b,c){var d,e=c*b,f=6*a,g=e*(1-Math.abs(f%2-1)),h=c-e;return d=1>f?{R:e,G:g,B:0}:2>f?{R:g,G:e,B:0}:3>f?{R:0,G:e,B:g}:4>f?{R:0,G:g,B:e}:5>f?{R:g,G:0,B:e}:{R:e,G:0,B:g},d.R+=h,d.G+=h,d.B+=h,d.R*=255,d.G*=255,d.B*=255,d}},keybindings={listBindings:function(a,b,c){var d,e,f,g,h,i=document.createDocumentFragment();for(d in a)h=a[d],e=document.createElement("li"),f=document.createElement("span"),f.className="key",f.textContent=d,e.appendChild(f),f=document.createElement("span"),f.textContent=" to ",e.appendChild(f),g=document.createElement("a"),g.href="#",g.textContent=b[h].description,g.addEventListener("click",b[h].callback),e.appendChild(g),i.appendChild(e);c.appendChild(i)},bindKeys:function(a,b){function c(a){return String.fromCharCode(a)}document.addEventListener("keypress",function(d){var e=b[a[c(d.charCode)]];e&&(e.callback(),d.stopPropagation(),d.preventDefault())})}},metaball={vx:0,vy:0,ax:0,ay:0,f:function(a,b){var c=a-this.x0,d=b-this.y0,e=c*c+d*d;return e<this.R2?1:this.R2/e},F:function(a){return a>this.Rwell?this.R2/(a*a):this.R2*a*(this.a*a+this.b)},computeCoefficients:function(a){this.a=3*(2*a*this.Rwell+3)/Math.pow(this.Rwell,4),this.b=1/Math.pow(this.Rwell,3)-this.a*this.Rwell},createRandomBall:function(a){var b=Object.create(this),c=Math.round(a.rMin*a.width),d=Math.round(a.rMax*a.width);return b.R=c+Math.round(Math.random()*(d-c)),b.Rcoll=Math.round(a.rColl*b.R),b.Rwell=Math.round(a.rWell*b.R),b.R2=b.R*b.R,b.oneOverR2=1/b.R2,b.computeCoefficients(a.k),b.x0=b.R+Math.round(Math.random()*(a.width-2*b.R)),b.y0=b.R+Math.round(Math.random()*(a.height-2*b.R)),b.RGB=graphics.HSVtoRGB(a.hMin+(a.hMax-a.hMin)*Math.random(),1,1),b},precomputeField:function(a){var b,c,d,e,f,g,h=0,i=2*a.width,j=2*a.height;for(b=Uint8Array?new Uint8Array(new ArrayBuffer(12*a.width*a.height)):[],c=this.x0,d=this.y0,this.x0=a.width,this.y0=a.height,f=0;j>f;f++)for(e=0;i>e;e++)g=this.f(e,f),b[h++]=g*this.RGB.R,b[h++]=g*this.RGB.G,b[h++]=g*this.RGB.B;return this.x0=c,this.y0=d,b}},metaballs={fields:[],balls:[],computeCoefficients:function(a){var b,c=this.balls.length;for(b=0;c>b;b++)this.balls[b].computeCoefficients(a)},generateBalls:function(a){var b=a.nBalls;for(this.balls=[];b--;)this.addNonCollidingBall(a)},addNonCollidingBall:function(a){var b;do b=metaball.createRandomBall(a);while(this.collidesOthers(b));a.highPrecision===!1&&this.fields.push(b.precomputeField(a)),this.balls.push(b)},popBall:function(){this.balls.pop(),this.fields.pop()},collidesOthers:function(a){var b,c,d,e,f,g=this.balls.length;for(b=0;g>b;b++)if(e=this.balls[b],c=a.x0-e.x0,d=a.y0-e.y0,f=a.R+e.R,f*f>c*c+d*d)return!0;return!1},precomputeFields:function(a){var b,c=this.balls.length;for(this.fields=[],b=0;c>b;b++)this.fields[b]=this.balls[b].precomputeField(a)},discardFields:function(){this.fields=[]}};